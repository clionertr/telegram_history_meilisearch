# é¡¹ç›®è¿›å±•è®°å½•ï¼šTelegram ä¸­æ–‡å†å²æ¶ˆæ¯ä¾¿æ·æœç´¢

## é˜¶æ®µ 0: é¡¹ç›®åˆå§‹åŒ–ä¸ç¯å¢ƒå‡†å¤‡

### ä»»åŠ¡ 1: åˆå§‹åŒ–é¡¹ç›®ç»“æ„ (å·²å®Œæˆ)
*   **å®Œæˆæ—¶é—´:** 2025/5/19 ä¸‹åˆ8:59
*   **æ‰§è¡Œè€…:** ğŸ’» Code Mode
*   **ä¸»è¦æˆæœ:**
    *   æ ¹æ® `FOLLOWME.md` å’Œ `memory-bank/PLAN.md` çš„å®šä¹‰ï¼ŒæˆåŠŸåˆ›å»ºäº†é¡¹ç›®æ‰€éœ€çš„åç«¯å’Œå‰ç«¯ç›®å½•ç»“æ„ã€‚
    *   åœ¨ç›¸åº”ç›®å½•ä¸­åˆ›å»ºäº†ç©ºçš„éª¨æ¶æ–‡ä»¶ã€‚
    *   é¡¹ç›®å·²é€šè¿‡ `git init` åˆå§‹åŒ–ä¸º Git ä»“åº“ã€‚
    *   åˆ›å»ºäº†åŸºç¡€çš„ `README.md` æ–‡ä»¶ï¼ŒåŒ…å«é¡¹ç›®æ„¿æ™¯ã€‚
    *   åˆ›å»ºäº† `.gitignore` æ–‡ä»¶ï¼ŒåŒ…å« Python, Node.js, Meilisearch åŠå¸¸è§ IDE çš„å¿½ç•¥è§„åˆ™ã€‚
*   **è¯¦ç»†æ—¥å¿—:** å®Œæ•´çš„æ‰§è¡Œæ­¥éª¤ã€å‘½ä»¤å’Œæ€è€ƒè¿‡ç¨‹å·²è®°å½•åœ¨ [`memory-bank/activeContext.md`](memory-bank/activeContext.md:0) (ç‰ˆæœ¬ï¼šä»»åŠ¡1 - åˆå§‹åŒ–é¡¹ç›®ç»“æ„)ã€‚

---

### ä»»åŠ¡ 2: æ­å»ºæœ¬åœ°å¼€å‘ç¯å¢ƒ (å·²å®Œæˆ)
*   **å®Œæˆæ—¶é—´:** 2025/5/19 ä¸‹åˆ9:07
*   **æ‰§è¡Œè€…:** ğŸ’» Code Mode
*   **ä¸»è¦æˆæœ:**
    *   **Meilisearch æœåŠ¡é…ç½®:** åˆ›å»ºäº† [`docker-compose.yml`](docker-compose.yml:0) æ–‡ä»¶ï¼Œé…ç½®äº† Meilisearch æœåŠ¡ (ç«¯å£ `7700`, æ•°æ®å· `./meili_data`, `MEILI_MASTER_KEY`)ã€‚
    *   **Python åç«¯ç¯å¢ƒ:**
        *   åˆ›å»ºäº† [`requirements.txt`](requirements.txt:0) æ–‡ä»¶ï¼ŒåŒ…å«æ ¸å¿ƒä¾èµ– (Telethon, meilisearch-python, FastAPI, python-dotenv, Pydantic, uvicorn)ã€‚
        *   æä¾›äº†ä½¿ç”¨ `uv` åˆ›å»º Python è™šæ‹Ÿç¯å¢ƒ (`.venv`) å’Œå®‰è£…ä¾èµ–çš„å‘½ä»¤ã€‚
    *   **Node.js å‰ç«¯ç¯å¢ƒæ£€æŸ¥:** æä¾›äº†æ£€æŸ¥ Node.js å’Œ npm/yarn ç‰ˆæœ¬çš„å‘½ä»¤ã€‚
    *   **ç¯å¢ƒå˜é‡æ–‡ä»¶:** åˆ›å»ºäº† [`.env.example`](.env.example:0) å’Œ [`.env`](.env:0) æ–‡ä»¶ï¼Œå¹¶é…ç½®äº† `MEILISEARCH_API_KEY`ï¼Œå…¶ä»–æ•æ„Ÿä¿¡æ¯ç•™å¾…ç”¨æˆ·å¡«å†™ã€‚
*   **è¯¦ç»†æ—¥å¿—:** å®Œæ•´çš„æ‰§è¡Œæ­¥éª¤ã€ç”Ÿæˆçš„é…ç½®æ–‡ä»¶å†…å®¹å’Œç›¸å…³å‘½ä»¤å·²è®°å½•åœ¨ [`memory-bank/activeContext.md`](memory-bank/activeContext.md:0) (ç‰ˆæœ¬ï¼šä»»åŠ¡2 - æ­å»ºæœ¬åœ°å¼€å‘ç¯å¢ƒ)ã€‚

---

### ä»»åŠ¡ 3: æ›´æ–°æ–‡æ¡£ä¸é¡¹ç›®ç¯å¢ƒé…ç½® (æ ¹æ®ç”¨æˆ·æ–°æŒ‡ä»¤) (å·²å®Œæˆ)
*   **å®Œæˆæ—¶é—´:** 2025/5/19 ä¸‹åˆ11:08 (å¤§è‡´æ—¶é—´ï¼ŒåŸºäºå­ä»»åŠ¡æŠ¥å‘Š)
*   **æ‰§è¡Œè€…:** ğŸ’» Code Mode
*   **ä¸»è¦æˆæœ:**
    *   **[`FOLLOWME.md`](FOLLOWME.md:0) æ›´æ–°:**
        *   æ˜ç¡® Search Bot å°†æ”¹ç”¨ Telethon å®ç°ã€‚
        *   è¡¥å……äº†ä½¿ç”¨ `pyproject.toml` çš„ `project.requires-python` å’Œ `uv` è¿›è¡Œ Python ç‰ˆæœ¬ç®¡ç†çš„è¯´æ˜ã€‚
    *   **[`memory-bank/PLAN.md`](memory-bank/PLAN.md:0) æ›´æ–°:**
        *   è°ƒæ•´äº†ç¯å¢ƒå‡†å¤‡é˜¶æ®µçš„ä¾èµ–æè¿°ã€‚
        *   é‡æ„äº†åç«¯å¼€å‘é˜¶æ®µä¸­ `search_bot` ç›¸å…³æ¨¡å—çš„å¼€å‘è®¡åˆ’ï¼Œä»¥é€‚åº” Telethon å®ç°ã€‚
        *   è¡¥å……äº†å…³äº `pyproject.toml` å’Œ Python ç‰ˆæœ¬ç®¡ç†çš„è¯´æ˜ã€‚
    *   **[`requirements.txt`](requirements.txt:0) ç¡®è®¤:** æ–‡ä»¶å†…å®¹å·²ç¬¦åˆæ–°è¦æ±‚ï¼Œæ— éœ€ä¿®æ”¹ (æœªåŒ…å« `python-telegram-bot`)ã€‚
    *   **[`pyproject.toml`](pyproject.toml:0) æ›´æ–°:** `requires-python` ç‰ˆæœ¬çº¦æŸå·²ä¿®æ”¹ä¸º `>=3.9`ã€‚
*   **è¯¦ç»†æ—¥å¿—:** å®Œæ•´çš„ä¿®æ”¹è®¡åˆ’ã€æ­¥éª¤å’Œæ€è€ƒè¿‡ç¨‹å·²è®°å½•åœ¨ [`memory-bank/activeContext.md`](memory-bank/activeContext.md:0) (ç‰ˆæœ¬ï¼šä»»åŠ¡3 - æ–‡æ¡£ä¸ç¯å¢ƒæ›´æ–°)ã€‚

---

## é˜¶æ®µ 1: åç«¯æ ¸å¿ƒåŠŸèƒ½å¼€å‘ä¸æµ‹è¯•

### ä»»åŠ¡ 1.1: `core/config_manager.py` å¼€å‘ (å·²å®Œæˆ)
*   **å®Œæˆæ—¶é—´:** 2025/5/20 ä¸Šåˆ0:02 (å¤§è‡´æ—¶é—´ï¼ŒåŸºäºå­ä»»åŠ¡æŠ¥å‘Š)
*   **æ‰§è¡Œè€…:** ğŸ’» Code Mode
*   **ä¸»è¦æˆæœ:**
    *   å®ç°äº† `ConfigManager` ç±»ï¼Œç”¨äºåŠ è½½ `.env` æ–‡ä»¶å’Œ `config.ini` æ–‡ä»¶ä¸­çš„é…ç½®ã€‚
    *   æä¾›äº†è·å–ç¯å¢ƒå˜é‡å’Œé…ç½®é¡¹çš„æ–¹æ³•ï¼Œèƒ½ä¼˜é›…å¤„ç†é…ç½®ä¸å­˜åœ¨çš„æƒ…å†µã€‚
    *   å®ç°äº†åŸºäº JSON æ–‡ä»¶ (`whitelist.json`) çš„ç™½åå•ç®¡ç†åŠŸèƒ½ (è¯»å–ã€æ·»åŠ ã€ç§»é™¤)ã€‚
    *   å®ç°äº†åœ¨é¦–æ¬¡åŠ è½½æ—¶è‡ªåŠ¨åˆ›å»º `config.ini`, `whitelist.json` åŠå…¶å¯¹åº”çš„ `.example` æ–‡ä»¶çš„é€»è¾‘ã€‚
    *   ç¼–å†™äº†å…¨é¢çš„å•å…ƒæµ‹è¯• ([`tests/unit/test_config_manager.py`](tests/unit/test_config_manager.py:0)) å¹¶å…¨éƒ¨é€šè¿‡ã€‚
    *   åˆ›å»ºäº† [`config.ini.example`](config.ini.example:0) å’Œ [`whitelist.json.example`](whitelist.json.example:0) ä½œä¸ºé…ç½®æ¨¡æ¿ã€‚
*   **è¯¦ç»†æ—¥å¿—:** å®Œæ•´çš„å¼€å‘è¿‡ç¨‹ã€è®¾è®¡æ€è·¯ã€ä»£ç å®ç°å’Œæµ‹è¯•ç»“æœå·²è®°å½•åœ¨ [`memory-bank/activeContext.md`](memory-bank/activeContext.md:0) (ç‰ˆæœ¬ï¼šé˜¶æ®µ1 - `core/config_manager.py` å¼€å‘)ã€‚

---

### ä»»åŠ¡ 1.2: `core/models.py` å¼€å‘ (å·²å®Œæˆ)
*   **å®Œæˆæ—¶é—´:** 2025/5/20 ä¸Šåˆ0:57 (å¤§è‡´æ—¶é—´ï¼ŒåŸºäºå­ä»»åŠ¡æŠ¥å‘Š)
*   **æ‰§è¡Œè€…:** ğŸ’» Code Mode
*   **ä¸»è¦æˆæœ:**
    *   åœ¨ [`core/models.py`](core/models.py:0) ä¸­å®šä¹‰äº† `MeiliMessageDoc` Pydantic æ¨¡å‹ï¼Œä¸¥æ ¼æŒ‰ç…§ [`FOLLOWME.md`](FOLLOWME.md:0) 4.1.3 èŠ‚çš„å­—æ®µå’Œç±»å‹è¦æ±‚ã€‚
    *   ä½¿ç”¨äº† `typing.Optional` å¤„ç†å¯é€‰å­—æ®µï¼Œå¹¶ç”¨ `typing.Literal` çº¦æŸäº† `chat_type` å­—æ®µçš„æšä¸¾å€¼ã€‚
    *   ç¼–å†™äº†å…¨é¢çš„å•å…ƒæµ‹è¯• ([`tests/unit/test_models.py`](tests/unit/test_models.py:0))ï¼Œè¦†ç›–äº†æ¨¡å‹åˆ›å»ºã€æ•°æ®éªŒè¯ã€å¿…éœ€å­—æ®µã€å¯é€‰å­—æ®µåŠ `Literal` çº¦æŸç­‰åœºæ™¯ï¼Œæ‰€æœ‰æµ‹è¯•å‡å·²é€šè¿‡ã€‚
*   **è¯¦ç»†æ—¥å¿—:** å®Œæ•´çš„éœ€æ±‚åˆ†æã€å®ç°æ€è·¯ã€ä»£ç å®ç°å’Œæµ‹è¯•è¿‡ç¨‹å·²è®°å½•åœ¨ [`memory-bank/activeContext.md`](memory-bank/activeContext.md:0) (ç‰ˆæœ¬ï¼šé˜¶æ®µ1 - `core/models.py` å¼€å‘)ã€‚

---

### ä»»åŠ¡ 1.3: `core/meilisearch_service.py` å¼€å‘ (å·²å®Œæˆ)
*   **å®Œæˆæ—¶é—´:** 2025/5/20 ä¸‹åˆ1:07 (å¤§è‡´æ—¶é—´ï¼ŒåŸºäºå­ä»»åŠ¡æŠ¥å‘Š)
*   **æ‰§è¡Œè€…:** ğŸ’» Code Mode
*   **ä¸»è¦æˆæœ:**
    *   å®ç°äº† `MeiliSearchService` ç±» ([`core/meilisearch_service.py`](core/meilisearch_service.py:0))ï¼Œæä¾›ä¸ Meilisearch æœåŠ¡çš„å®Œæ•´äº¤äº’åŠŸèƒ½ã€‚
    *   åŠŸèƒ½åŒ…æ‹¬ï¼šå®¢æˆ·ç«¯åˆå§‹åŒ–ã€ç´¢å¼•è‡ªåŠ¨åˆ›å»ºä¸é…ç½® (searchable, filterable, sortable attributes, ranking rules)ã€å•æ¡åŠæ‰¹é‡æ¶ˆæ¯ç´¢å¼•ã€å¼ºå¤§çš„æœç´¢åŠŸèƒ½ (å…³é”®è¯ã€è¿‡æ»¤ã€æ’åºã€åˆ†é¡µ) å’Œæ¶ˆæ¯åˆ é™¤ã€‚
    *   é¢å¤–å®ç°äº†åœç”¨è¯ (`update_stop_words`) å’ŒåŒä¹‰è¯ (`update_synonyms`) çš„é…ç½®æ–¹æ³•ã€‚
    *   ç¼–å†™äº†å…¨é¢çš„é›†æˆæµ‹è¯• ([`tests/integration/test_meilisearch_service.py`](tests/integration/test_meilisearch_service.py:0))ï¼Œè¦†ç›–æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼Œå¹¶åœ¨æœ¬åœ° Docker ç¯å¢ƒä¸‹æˆåŠŸè¿è¡Œã€‚
*   **è¯¦ç»†æ—¥å¿—:** è¯¦ç»†çš„è®¾è®¡ã€å®ç°ã€é—®é¢˜è§£å†³å’Œæµ‹è¯•è¿‡ç¨‹å·²è®°å½•åœ¨ [`memory-bank/activeContext.md`](memory-bank/activeContext.md:0) (ç‰ˆæœ¬ï¼šé˜¶æ®µ1 - `core/meilisearch_service.py` å¼€å‘)ã€‚

---

### ä»»åŠ¡ 1.4: `user_bot/client.py` å¼€å‘ (å·²å®Œæˆ)
*   **å®Œæˆæ—¶é—´:** 2025/5/20 ä¸‹åˆ1:17 (å¤§è‡´æ—¶é—´ï¼ŒåŸºäºå­ä»»åŠ¡æŠ¥å‘Š)
*   **æ‰§è¡Œè€…:** ğŸ’» Code Mode
*   **ä¸»è¦æˆæœ:**
    *   å®ç°äº† `UserBotClient` ç±» ([`user_bot/client.py`](user_bot/client.py:0))ï¼Œé‡‡ç”¨å•ä¾‹æ¨¡å¼ç®¡ç† Telethon å®¢æˆ·ç«¯å®ä¾‹ã€‚
    *   ä» `ConfigManager` å®‰å…¨è·å– API ID å’Œ HASHï¼Œç®¡ç†å­˜å‚¨åœ¨ `.sessions/` ç›®å½•ä¸‹çš„ç”¨æˆ·ä¼šè¯æ–‡ä»¶ (å·²æ›´æ–° `.gitignore`)ã€‚
    *   å¤„ç†äº†é¦–æ¬¡äº¤äº’å¼ç™»å½•æµç¨‹ï¼Œå¹¶æä¾›äº†æ¸…æ™°çš„æ—¥å¿—æŒ‡å¯¼ã€‚
    *   ç¼–å†™äº†å…¨é¢çš„å•å…ƒæµ‹è¯• ([`tests/unit/test_user_bot_client.py`](tests/unit/test_user_bot_client.py:0))ï¼Œè¦†ç›–äº†å®¢æˆ·ç«¯åˆå§‹åŒ–ã€ç™»å½•ã€ä¼šè¯ç®¡ç†åŠå¼‚å¸¸å¤„ç†ï¼ˆå¦‚ä¼šè¯è¿‡æœŸï¼‰ç­‰åœºæ™¯ã€‚
*   **è¯¦ç»†æ—¥å¿—:** è¯¦ç»†çš„è®¾è®¡æ€è·¯ã€å®ç°æ­¥éª¤ã€é¦–æ¬¡ç™»å½•å¤„ç†ã€å¾…è€ƒè™‘é—®é¢˜åŠå•å…ƒæµ‹è¯•ç­–ç•¥å·²è®°å½•åœ¨ [`memory-bank/activeContext.md`](memory-bank/activeContext.md:0) (ç‰ˆæœ¬ï¼šé˜¶æ®µ1 - `user_bot/client.py` å¼€å‘)ã€‚

---

### ä»»åŠ¡ 1.5: `user_bot/event_handlers.py` å’Œ `user_bot/utils.py` å¼€å‘ (å·²å®Œæˆ)
*   **å®Œæˆæ—¶é—´:** 2025/5/20 ä¸‹åˆ1:24 (å¤§è‡´æ—¶é—´ï¼ŒåŸºäºå­ä»»åŠ¡æŠ¥å‘Š)
*   **æ‰§è¡Œè€…:** ğŸ’» Code Mode
*   **ä¸»è¦æˆæœ:**
    *   åœ¨ [`user_bot/utils.py`](user_bot/utils.py:0) ä¸­å®ç°äº† `generate_message_link`, `format_sender_name`, `determine_chat_type` ç­‰è¾…åŠ©å‡½æ•°ã€‚
    *   åœ¨ [`user_bot/event_handlers.py`](user_bot/event_handlers.py:0) ä¸­å®ç°äº† `handle_new_message` å’Œ `handle_message_edited` äº‹ä»¶å¤„ç†å‡½æ•°ã€‚
    *   å®ç°äº†æœåŠ¡è·å–ï¼ˆConfigManager, MeiliSearchServiceï¼‰çš„å•ä¾‹æ¨¡å¼è®¿é—®ã€‚
    *   äº‹ä»¶å¤„ç†é€»è¾‘åŒ…æ‹¬ï¼šç™½åå•æ£€æŸ¥ã€ä» Telethon äº‹ä»¶ä¸­å‡†ç¡®æå–æ¶ˆæ¯æ•°æ®ã€å°†æ¶ˆæ¯è½¬æ¢ä¸º `MeiliMessageDoc` æ¨¡å‹ã€é€šè¿‡ `MeiliSearchService` ç´¢å¼•æ¶ˆæ¯åˆ° Meilisearchã€‚
    *   åŒ…å«äº†å…¨é¢çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•ã€‚
    *   åœ¨ä»£ç æ³¨é‡Šä¸­è¯´æ˜äº†äº‹ä»¶å¤„ç†å™¨å¦‚ä½•æ³¨å†Œåˆ° Telethon å®¢æˆ·ç«¯ã€‚
*   **è¯¦ç»†æ—¥å¿—:** è¯¦ç»†çš„è®¾è®¡æ€è·¯ã€å®ç°æ­¥éª¤ã€å…³é”®å†³ç­–ã€å­—æ®µæå–é€»è¾‘å’Œé”™è¯¯å¤„ç†å·²è®°å½•åœ¨ [`memory-bank/activeContext.md`](memory-bank/activeContext.md:0) (ç‰ˆæœ¬ï¼šé˜¶æ®µ1 - `user_bot/event_handlers.py` å¼€å‘)ã€‚

---

### ä»»åŠ¡ 1.6: `user_bot/history_syncer.py` å¼€å‘ (å·²å®Œæˆ)
*   **å®Œæˆæ—¶é—´:** 2025/5/20 ä¸‹åˆ1:33 (å¤§è‡´æ—¶é—´ï¼ŒåŸºäºå­ä»»åŠ¡æŠ¥å‘Š)
*   **æ‰§è¡Œè€…:** ğŸ’» Code Mode
*   **ä¸»è¦æˆæœ:**
    *   åœ¨ [`user_bot/history_syncer.py`](user_bot/history_syncer.py:0) ä¸­å®ç°äº† `HistorySyncer` ç±»åŠä¾¿æ·å‡½æ•° `sync_chat_history` å’Œ `initial_sync_all_whitelisted_chats`ã€‚
    *   åŠŸèƒ½åŒ…æ‹¬ï¼šä»æŒ‡å®šèŠå¤©æˆ–æ‰€æœ‰ç™½åå•èŠå¤©ä¸­æ‹‰å–å†å²æ¶ˆæ¯ï¼Œåˆ†æ‰¹å¤„ç†æ¶ˆæ¯ä»¥é¿å… API é™åˆ¶å’Œå†…å­˜é—®é¢˜ã€‚
    *   å®ç°äº†æ¶ˆæ¯åˆ° `MeiliMessageDoc` çš„è½¬æ¢ï¼Œå¹¶å‡†å¤‡äº†æ‰¹é‡ç´¢å¼•åˆ° Meilisearch çš„é€»è¾‘ (å®é™…è°ƒç”¨ç”± `MeiliSearchService` å¤„ç†)ã€‚
    *   åŒ…å«äº†å¯¹ Telegram API é€Ÿç‡é™åˆ¶ (`FloodWaitError`) å’Œå…¶ä»–å¸¸è§é”™è¯¯çš„å¥å£®å¤„ç†ã€‚
    *   åˆæ­¥å®ç°äº†åœ¨å†…å­˜ä¸­è®°å½•æ¯ä¸ª chat çš„æœ€ååŒæ­¥ç‚¹ (message_id, date, timestamp)ï¼Œä¸ºæœªæ¥å¢é‡åŒæ­¥æ‰“ä¸‹åŸºç¡€ã€‚
    *   ä»£ç éµå¾ª PEP 8ï¼ŒåŒ…å«ç±»å‹æç¤ºå’Œè¯¦ç»†æ–‡æ¡£å­—ç¬¦ä¸²ã€‚
*   **è¯¦ç»†æ—¥å¿—:** è¯¦ç»†çš„éœ€æ±‚åˆ†æã€è®¾è®¡æ€è·¯ã€å®ç°ç»†èŠ‚ã€é”™è¯¯å¤„ç†ã€åŒæ­¥ç‚¹ç®¡ç†ã€å¯èƒ½çš„ä¼˜åŒ–ç‚¹å’Œæµ‹è¯•æ€è·¯å·²è®°å½•åœ¨ [`memory-bank/activeContext.md`](memory-bank/activeContext.md:0) (ç‰ˆæœ¬ï¼šé˜¶æ®µ1 - `user_bot/history_syncer.py` å¼€å‘)ã€‚

---
*(åç»­ä»»åŠ¡è¿›å±•å°†åœ¨æ­¤æ–‡ä»¶ä¸‹æ–¹æŒç»­æ›´æ–°)*